---
import MainLayout from '../../layouts/MainLayout.astro';
import MovieSlider from '../../components/MovieSlider.astro';

const { id } = Astro.params;

// Mock movie data - In production, fetch from TMDB API
const movie = {
  id: Number(id),
  title: "Dune: Part Two",
  originalTitle: "Dune: Part Two",
  overview: "Ikuti Paul Atreides dalam perjalanan epiknya bersama Chani dan Fremen saat ia menuntut balas atas konspirasi yang menghancurkan keluarganya. Menghadapi pilihan antara cinta hidupnya dan nasib alam semesta, Paul harus mencegah masa depan yang mengerikan yang hanya dia yang bisa lihat.",
  posterPath: "/8b8R8l88Qje9dn9OE8PY05Nxl1X.jpg",
  backdropPath: "/xOMo8BRK7PfcJv9JCnx7s5hj0PX.jpg",
  releaseDate: "2024-02-27",
  voteAverage: 8.4,
  voteCount: 12500,
  runtime: 166,
  status: "Released",
  tagline: "Long live the fighters.",
  budget: 190000000,
  revenue: 700000000,
  genres: [
    { id: 878, name: "Science Fiction" },
    { id: 12, name: "Adventure" },
    { id: 18, name: "Drama" }
  ],
  productionCompanies: [
    { id: 1, name: "Legendary Pictures", logoPath: "/8M99Dkt23MjQMTTWukq4m5XsEuo.png" },
    { id: 2, name: "Warner Bros.", logoPath: "/wdrCwmRnLFJhEoH8GSfymY85KHT.png" }
  ],
  credits: {
    cast: [
      { id: 1, name: "TimothÃ©e Chalamet", character: "Paul Atreides", profilePath: "/BE2sdjpgsa2rNTFa66f7upkaOP.jpg", order: 0 },
      { id: 2, name: "Zendaya", character: "Chani", profilePath: "/tylFh6gmVIqjaFFMdOVavEPAHj9.jpg", order: 1 },
      { id: 3, name: "Rebecca Ferguson", character: "Lady Jessica", profilePath: "/lJloTOheuQSirSLXNA3JHsrMNfH.jpg", order: 2 },
      { id: 4, name: "Josh Brolin", character: "Gurney Halleck", profilePath: "/sX2aySeDvZQWKQ3ld4sW1vQffR.jpg", order: 3 },
      { id: 5, name: "Austin Butler", character: "Feyd-Rautha", profilePath: "/9gBGvKDNfvQB3i6cL7zEJG4qjkh.jpg", order: 4 },
      { id: 6, name: "Florence Pugh", character: "Princess Irulan", profilePath: "/gXaZQ4PMJXZaAMCGFYF4C7HSYo2.jpg", order: 5 },
      { id: 7, name: "Dave Bautista", character: "Beast Rabban", profilePath: "/mYhS3PUPXASwlNzN7ROLgfsCpGF.jpg", order: 6 },
      { id: 8, name: "Christopher Walken", character: "Emperor Shaddam IV", profilePath: "/il1VhCnKmlwbhMqajKi1t96GkKV.jpg", order: 7 },
      { id: 9, name: "LÃ©a Seydoux", character: "Lady Margot", profilePath: "/l9hbL3xGPX9UuQvLF2D1DyLOvgE.jpg", order: 8 },
      { id: 10, name: "Javier Bardem", character: "Stilgar", profilePath: "/IShnFg6ijCJPHzxU0HddPAaUhc.jpg", order: 9 }
    ],
    crew: [
      { id: 1, name: "Denis Villeneuve", job: "Director", department: "Directing", profilePath: "/zdDx9Xs93UIrJFWYApYR28J8M6b.jpg" },
      { id: 2, name: "Hans Zimmer", job: "Original Music Composer", department: "Sound", profilePath: "/tpQnDeHY15szIXvpnhlprufz4d.jpg" }
    ]
  },
  videos: {
    results: [
      { id: "1", key: "Way9Dexny3w", name: "Official Trailer", site: "YouTube", type: "Trailer", official: true },
      { id: "2", key: "U2Qp5pL3ovA", name: "Final Trailer", site: "YouTube", type: "Trailer", official: true }
    ]
  }
};

const similarMovies = [
  { id: 201, title: "Dune", posterPath: "/d5NXSklXo0qyIYkgV94XAgMIckC.jpg", releaseDate: "2021-09-15", voteAverage: 7.8, genreIds: [878, 12] },
  { id: 202, title: "Blade Runner 2049", posterPath: "/gajva2L0rPYkEWjzgFlBXCAVBE5.jpg", releaseDate: "2017-10-04", voteAverage: 7.6, genreIds: [878, 18] },
  { id: 203, title: "Interstellar", posterPath: "/gEU2QniE6E77NI6lCU6MxlNBvIx.jpg", releaseDate: "2014-11-05", voteAverage: 8.4, genreIds: [12, 18, 878] },
  { id: 204, title: "Arrival", posterPath: "/x2FJsf1ElAgr63Y3PNPtJrcmpoe.jpg", releaseDate: "2016-11-10", voteAverage: 7.6, genreIds: [18, 878] },
  { id: 205, title: "The Martian", posterPath: "/5BHuvQ6p9kfc091Z8RiFNhCwL4b.jpg", releaseDate: "2015-09-30", voteAverage: 8.0, genreIds: [18, 12, 878] },
  { id: 206, title: "Avatar", posterPath: "/kyeqWdyUXW608AAAATVpHaLuqeN.jpg", releaseDate: "2009-12-15", voteAverage: 7.6, genreIds: [28, 12, 14, 878] }
];

const reviews = [
  {
    id: "1",
    user: { displayName: "FilmFanatic", avatar: null },
    rating: 9,
    title: "Masterpiece visual yang memukau!",
    content: "Denis Villeneuve berhasil menciptakan sekuel yang bahkan lebih baik dari film pertama. Visual yang memukau, akting yang luar biasa, dan musik Hans Zimmer yang menggetarkan jiwa.",
    likes: 234,
    createdAt: "2024-03-01"
  },
  {
    id: "2",
    user: { displayName: "CinemaLover", avatar: null },
    rating: 8,
    title: "Epic dan Emosional",
    content: "Film ini berhasil membawa emosi yang mendalam. Chemistry antara TimothÃ©e dan Zendaya sangat terasa natural. Wajib tonton di bioskop!",
    likes: 156,
    createdAt: "2024-03-02"
  },
  {
    id: "3",
    user: { displayName: "SciFiGeek", avatar: null },
    rating: 10,
    title: "Film Sci-Fi terbaik dekade ini",
    content: "Tidak ada kata yang cukup untuk mendeskripsikan betapa spektakulernya film ini. Setiap frame adalah karya seni. Hans Zimmer sekali lagi membuktikan dia adalah maestro soundtrack.",
    likes: 189,
    createdAt: "2024-03-03"
  }
];

const formatCurrency = (num: number) => {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
};

const formatRuntime = (minutes: number) => {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  return `${hours}j ${mins}m`;
};

const getRatingClass = (rating: number) => {
  if (rating >= 7) return 'rating-high';
  if (rating >= 5) return 'rating-medium';
  return 'rating-low';
};

const imageBaseUrl = 'https://image.tmdb.org/t/p';
---

<MainLayout title={`${movie.title} - ASTRO`} description={movie.overview}>
  <!-- Backdrop -->
  <div class="relative">
    <div class="absolute inset-0 h-[70vh]">
      <img 
        src={`${imageBaseUrl}/original${movie.backdropPath}`}
        alt={movie.title}
        class="w-full h-full object-cover"
      />
      <div class="hero-gradient absolute inset-0"></div>
      <div class="absolute inset-0 bg-gradient-to-r from-dark-500 via-dark-500/70 to-transparent"></div>
    </div>

    <!-- Movie Info -->
    <div class="relative pt-20 pb-12 container-custom">
      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
        <!-- Poster -->
        <div class="flex-shrink-0 mx-auto lg:mx-0">
          <div class="w-64 md:w-80 rounded-2xl overflow-hidden shadow-card border border-dark-100">
            <img 
              src={`${imageBaseUrl}/w500${movie.posterPath}`}
              alt={movie.title}
              class="w-full aspect-poster object-cover"
            />
          </div>
        </div>

        <!-- Info -->
        <div class="flex-1 space-y-6">
          <!-- Title & Meta -->
          <div>
            <div class="flex flex-wrap items-center gap-3 mb-4">
              {movie.genres.map((genre) => (
                <a href={`/genre/${genre.id}`} class="badge-primary">
                  {genre.name}
                </a>
              ))}
            </div>
            <h1 class="text-3xl md:text-4xl lg:text-5xl font-display font-bold text-white mb-2">
              {movie.title}
            </h1>
            {movie.tagline && (
              <p class="text-xl text-secondary-400 italic">"{movie.tagline}"</p>
            )}
          </div>

          <!-- Stats -->
          <div class="flex flex-wrap items-center gap-6">
            <div class={`${getRatingClass(movie.voteAverage)} w-16 h-16 text-lg`}>
              {movie.voteAverage.toFixed(1)}
            </div>
            <div>
              <div class="text-white font-bold">{movie.voteCount.toLocaleString()}</div>
              <div class="text-secondary-400 text-sm">Votes</div>
            </div>
            <div>
              <div class="text-white font-bold">{new Date(movie.releaseDate).getFullYear()}</div>
              <div class="text-secondary-400 text-sm">Tahun</div>
            </div>
            <div>
              <div class="text-white font-bold">{formatRuntime(movie.runtime)}</div>
              <div class="text-secondary-400 text-sm">Durasi</div>
            </div>
          </div>

          <!-- Overview -->
          <div>
            <h2 class="text-lg font-semibold text-white mb-2">Sinopsis</h2>
            <p class="text-secondary-300 leading-relaxed">{movie.overview}</p>
          </div>

          <!-- Director -->
          <div class="flex items-center gap-4">
            <span class="text-secondary-400">Sutradara:</span>
            {movie.credits.crew.filter(c => c.job === 'Director').map((director) => (
              <a href={`/orang/${director.id}`} class="text-white hover:text-primary-400 transition-colors">
                {director.name}
              </a>
            ))}
          </div>

          <!-- Actions -->
          <div class="flex flex-wrap items-center gap-4 pt-4">
            <button id="play-trailer" class="btn-primary px-8 py-4 text-lg">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M8 5v14l11-7z"/>
              </svg>
              Tonton Trailer
            </button>
            <button id="add-watchlist" class="btn-secondary px-6 py-4">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/>
              </svg>
              Watchlist
            </button>
            <button id="add-favorite" class="btn-secondary px-6 py-4">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
              </svg>
              Favorit
            </button>
            <button class="btn-icon">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Content Tabs -->
  <section class="container-custom py-8">
    <div class="tabs max-w-md mb-8">
      <button class="tab active" data-tab="cast">Pemeran</button>
      <button class="tab" data-tab="videos">Video</button>
      <button class="tab" data-tab="reviews">Review</button>
      <button class="tab" data-tab="info">Info</button>
    </div>

    <!-- Cast Tab -->
    <div id="tab-cast" class="tab-content">
      <h2 class="text-xl font-bold text-white mb-6">Pemeran & Kru</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
        {movie.credits.cast.slice(0, 10).map((person) => (
          <a href={`/orang/${person.id}`} class="card-hover p-4 text-center group">
            <div class="w-20 h-20 mx-auto mb-3 rounded-full overflow-hidden bg-dark-200">
              {person.profilePath ? (
                <img 
                  src={`${imageBaseUrl}/w185${person.profilePath}`}
                  alt={person.name}
                  class="w-full h-full object-cover"
                />
              ) : (
                <div class="w-full h-full flex items-center justify-center text-secondary-500">
                  <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                  </svg>
                </div>
              )}
            </div>
            <h3 class="text-white font-medium text-sm group-hover:text-primary-400 transition-colors">
              {person.name}
            </h3>
            <p class="text-secondary-500 text-xs">{person.character}</p>
          </a>
        ))}
      </div>
    </div>

    <!-- Videos Tab -->
    <div id="tab-videos" class="tab-content hidden">
      <h2 class="text-xl font-bold text-white mb-6">Video & Trailer</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {movie.videos.results.map((video) => (
          <div class="card-hover overflow-hidden">
            <div class="relative aspect-video bg-dark-300 cursor-pointer group" data-video={video.key}>
              <img 
                src={`https://img.youtube.com/vi/${video.key}/maxresdefault.jpg`}
                alt={video.name}
                class="w-full h-full object-cover"
              />
              <div class="absolute inset-0 bg-black/40 flex items-center justify-center group-hover:bg-black/60 transition-colors">
                <div class="w-16 h-16 rounded-full bg-primary-500 flex items-center justify-center shadow-glow group-hover:scale-110 transition-transform">
                  <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </div>
              </div>
            </div>
            <div class="p-4">
              <h3 class="text-white font-medium">{video.name}</h3>
              <p class="text-secondary-400 text-sm">{video.type}</p>
            </div>
          </div>
        ))}
      </div>
    </div>

    <!-- Reviews Tab -->
    <div id="tab-reviews" class="tab-content hidden">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-white">Review Pengguna</h2>
        <a href={`/film/${id}/tulis-review`} class="btn-primary">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
          </svg>
          Tulis Review
        </a>
      </div>

      <div class="space-y-6">
        {reviews.map((review) => (
          <div class="review-card">
            <div class="flex items-start gap-4">
              <div class="avatar avatar-lg bg-gradient-primary flex items-center justify-center text-white font-bold">
                {review.user.displayName.charAt(0)}
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                  <span class="text-white font-medium">{review.user.displayName}</span>
                  <div class="flex items-center gap-1">
                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                    <span class="text-white font-bold text-sm">{review.rating}/10</span>
                  </div>
                  <span class="text-secondary-500 text-sm">{review.createdAt}</span>
                </div>
                <h3 class="text-white font-semibold mb-2">{review.title}</h3>
                <p class="text-secondary-300">{review.content}</p>
                <div class="flex items-center gap-4 mt-4">
                  <button class="flex items-center gap-2 text-secondary-400 hover:text-primary-400 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10h4.764a2 2 0 011.789 2.894l-3.5 7A2 2 0 0115.263 21h-4.017c-.163 0-.326-.02-.485-.06L7 20m7-10V5a2 2 0 00-2-2h-.095c-.5 0-.905.405-.905.905 0 .714-.211 1.412-.608 2.006L7 11v9m7-10h-2M7 20H5a2 2 0 01-2-2v-6a2 2 0 012-2h2.5"/>
                    </svg>
                    <span>{review.likes}</span>
                  </button>
                  <button class="text-secondary-400 hover:text-white transition-colors text-sm">
                    Balas
                  </button>
                  <button class="text-secondary-400 hover:text-red-400 transition-colors text-sm">
                    Laporkan
                  </button>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      <div class="mt-8 text-center">
        <a href={`/film/${id}/reviews`} class="btn-secondary">
          Lihat Semua Review
        </a>
      </div>
    </div>

    <!-- Info Tab -->
    <div id="tab-info" class="tab-content hidden">
      <h2 class="text-xl font-bold text-white mb-6">Informasi Film</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="space-y-4">
          <div class="flex justify-between py-3 border-b border-dark-100">
            <span class="text-secondary-400">Judul Asli</span>
            <span class="text-white">{movie.originalTitle}</span>
          </div>
          <div class="flex justify-between py-3 border-b border-dark-100">
            <span class="text-secondary-400">Status</span>
            <span class="badge-success">{movie.status}</span>
          </div>
          <div class="flex justify-between py-3 border-b border-dark-100">
            <span class="text-secondary-400">Tanggal Rilis</span>
            <span class="text-white">{new Date(movie.releaseDate).toLocaleDateString('id-ID', { dateStyle: 'long' })}</span>
          </div>
          <div class="flex justify-between py-3 border-b border-dark-100">
            <span class="text-secondary-400">Durasi</span>
            <span class="text-white">{formatRuntime(movie.runtime)}</span>
          </div>
        </div>
        <div class="space-y-4">
          <div class="flex justify-between py-3 border-b border-dark-100">
            <span class="text-secondary-400">Budget</span>
            <span class="text-white">{formatCurrency(movie.budget)}</span>
          </div>
          <div class="flex justify-between py-3 border-b border-dark-100">
            <span class="text-secondary-400">Revenue</span>
            <span class="text-green-400 font-bold">{formatCurrency(movie.revenue)}</span>
          </div>
          <div class="py-3 border-b border-dark-100">
            <span class="text-secondary-400 block mb-2">Produksi</span>
            <div class="flex flex-wrap gap-4">
              {movie.productionCompanies.map((company) => (
                <div class="flex items-center gap-2 bg-dark-300 px-3 py-2 rounded-lg">
                  {company.logoPath && (
                    <img 
                      src={`${imageBaseUrl}/w92${company.logoPath}`}
                      alt={company.name}
                      class="h-6 object-contain"
                    />
                  )}
                  <span class="text-white text-sm">{company.name}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Similar Movies -->
  <MovieSlider 
    title="ðŸŽ¬ Film Serupa"
    subtitle="Kamu mungkin juga suka"
    movies={similarMovies}
    viewAllLink={`/film/${id}/similar`}
  />

  <!-- Trailer Modal -->
  <div id="trailer-modal" class="modal-overlay hidden">
    <div class="modal-content max-w-4xl w-full p-0">
      <div class="flex items-center justify-between p-4 border-b border-dark-100">
        <h3 class="text-lg font-bold text-white">Trailer</h3>
        <button id="close-trailer" class="text-secondary-400 hover:text-white transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
      <div class="aspect-video bg-black">
        <iframe 
          id="trailer-iframe"
          class="w-full h-full"
          src=""
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      </div>
    </div>
  </div>
</MainLayout>

<script>
  // Tab switching
  const tabs = document.querySelectorAll('.tab');
  const tabContents = document.querySelectorAll('.tab-content');

  tabs.forEach((tab) => {
    tab.addEventListener('click', () => {
      const tabId = tab.getAttribute('data-tab');
      
      // Update tab styles
      tabs.forEach((t) => t.classList.remove('active'));
      tab.classList.add('active');
      
      // Show/hide content
      tabContents.forEach((content) => {
        content.classList.toggle('hidden', content.id !== `tab-${tabId}`);
      });
    });
  });

  // Trailer modal
  const trailerModal = document.getElementById('trailer-modal');
  const trailerIframe = document.getElementById('trailer-iframe') as HTMLIFrameElement;
  const playTrailerBtn = document.getElementById('play-trailer');
  const closeTrailerBtn = document.getElementById('close-trailer');
  
  const openTrailer = (videoKey: string) => {
    if (trailerIframe) {
      trailerIframe.src = `https://www.youtube.com/embed/${videoKey}?autoplay=1`;
    }
    trailerModal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  };

  const closeTrailer = () => {
    trailerModal?.classList.add('hidden');
    if (trailerIframe) {
      trailerIframe.src = '';
    }
    document.body.style.overflow = '';
  };

  playTrailerBtn?.addEventListener('click', () => {
    openTrailer('Way9Dexny3w'); // Default to first trailer
  });

  closeTrailerBtn?.addEventListener('click', closeTrailer);
  trailerModal?.addEventListener('click', (e) => {
    if (e.target === trailerModal) closeTrailer();
  });

  // Video thumbnails
  document.querySelectorAll('[data-video]').forEach((el) => {
    el.addEventListener('click', () => {
      const videoKey = el.getAttribute('data-video');
      if (videoKey) openTrailer(videoKey);
    });
  });

  // Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeTrailer();
  });
</script>
