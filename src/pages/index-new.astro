---
import MainLayout from '../layouts/MainLayout.astro';
import HeroSlider from '../components/HeroSlider.astro';
import MovieSlider from '../components/MovieSlider.astro';
import { Icon } from '@iconify/react';

// API endpoint for TMDB
const TMDB_API_KEY = import.meta.env.TMDB_API_KEY || '';
const TMDB_BASE = 'https://api.themoviedb.org/3';

// Fetch functions for real-time data
async function fetchTMDB(endpoint: string) {
  try {
    const res = await fetch(`${TMDB_BASE}${endpoint}?api_key=${TMDB_API_KEY}&language=id-ID`);
    if (!res.ok) throw new Error('Failed to fetch');
    return await res.json();
  } catch (error) {
    console.error('TMDB fetch error:', error);
    return null;
  }
}

// Fetch real-time data from TMDB
let trendingMovies = [];
let popularMovies = [];
let nowPlayingMovies = [];
let animeMovies = [];
let topRatedMovies = [];
let upcomingMovies = [];

try {
  const [trending, popular, nowPlaying, topRated, upcoming] = await Promise.all([
    fetchTMDB('/trending/movie/week'),
    fetchTMDB('/movie/popular'),
    fetchTMDB('/movie/now_playing'),
    fetchTMDB('/movie/top_rated'),
    fetchTMDB('/movie/upcoming'),
  ]);
  
  // Transform data
  const transformMovie = (m: any) => ({
    id: m.id,
    title: m.title || m.name,
    overview: m.overview,
    backdropPath: m.backdrop_path,
    posterPath: m.poster_path,
    releaseDate: m.release_date || m.first_air_date,
    voteAverage: m.vote_average,
    genreIds: m.genre_ids || []
  });
  
  trendingMovies = trending?.results?.slice(0, 5).map(transformMovie) || [];
  popularMovies = popular?.results?.slice(0, 10).map(transformMovie) || [];
  nowPlayingMovies = nowPlaying?.results?.slice(0, 10).map(transformMovie) || [];
  topRatedMovies = topRated?.results?.slice(0, 10).map(transformMovie) || [];
  upcomingMovies = upcoming?.results?.slice(0, 10).map(transformMovie) || [];
  
  // Fetch anime (animation genre)
  const animeData = await fetchTMDB('/discover/movie?with_genres=16&sort_by=popularity.desc');
  animeMovies = animeData?.results?.slice(0, 10).map(transformMovie) || [];
} catch (error) {
  console.error('Error fetching data:', error);
}

// Fallback mock data if API fails
if (trendingMovies.length === 0) {
  trendingMovies = [
    {
      id: 1,
      title: "Dune: Part Two",
      overview: "Ikuti Paul Atreides dalam perjalanan epiknya bersama Chani dan Fremen saat ia menuntut balas atas konspirasi yang menghancurkan keluarganya.",
      backdropPath: "/xOMo8BRK7PfcJv9JCnx7s5hj0PX.jpg",
      posterPath: "/8b8R8l88Qje9dn9OE8PY05Nxl1X.jpg",
      releaseDate: "2024-02-27",
      voteAverage: 8.4,
      genreIds: [878, 12, 18]
    }
  ];
}
---

<MainLayout title="ASTRO - Website Review Film Indonesia">
  <!-- Loading Screen Component -->
  <div id="loading-screen" class="fixed inset-0 z-[100] flex items-center justify-center bg-dark-500 transition-all duration-500">
    <div class="relative z-10 flex flex-col items-center">
      <!-- Animated Background Orbs -->
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 bg-primary-500/20 rounded-full blur-[100px] animate-pulse"></div>
      <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-64 h-64 bg-violet-500/20 rounded-full blur-[80px] animate-pulse" style="animation-delay: 0.5s;"></div>
      
      <!-- Logo Animation -->
      <div class="relative mb-8">
        <div class="w-28 h-28 bg-gradient-to-br from-primary-500 to-violet-500 rounded-3xl flex items-center justify-center shadow-glow animate-bounce-slow">
          <span class="text-5xl font-display font-bold text-white">A</span>
        </div>
        <!-- Sparkle effects -->
        <div class="absolute -top-2 -right-2 w-4 h-4 bg-white rounded-full animate-ping"></div>
        <div class="absolute -bottom-1 -left-1 w-3 h-3 bg-violet-400 rounded-full animate-ping" style="animation-delay: 0.3s;"></div>
      </div>
      
      <!-- Brand -->
      <h1 class="text-4xl font-display font-bold mb-4 bg-gradient-to-r from-primary-400 via-violet-400 to-magenta-400 bg-clip-text text-transparent">
        ASTRO
      </h1>
      <p class="text-secondary-400 mb-8">Website Review Film Indonesia</p>
      
      <!-- Progress bar -->
      <div class="w-48 h-1.5 bg-dark-300 rounded-full overflow-hidden">
        <div id="loading-progress" class="h-full bg-gradient-to-r from-primary-500 via-violet-500 to-magenta-500 rounded-full transition-all duration-300" style="width: 0%"></div>
      </div>
      
      <!-- Loading text -->
      <div class="mt-8 flex items-center gap-2 text-secondary-400">
        <div class="w-4 h-4 border-2 border-primary-500 border-t-transparent rounded-full animate-spin"></div>
        <span class="text-sm">Memuat pengalaman terbaik...</span>
      </div>
    </div>
  </div>

  <!-- Hero Slider -->
  <HeroSlider movies={trendingMovies} />

  <!-- Quick Categories - Using Icons instead of Emojis -->
  <section class="py-8 border-b border-dark-100">
    <div class="container-custom">
      <div class="flex items-center gap-3 overflow-x-auto hide-scrollbar pb-2">
        <a href="/film" class="flex-shrink-0 px-6 py-3 bg-gradient-primary text-white rounded-full font-medium hover:shadow-glow transition-all duration-300 flex items-center gap-2">
          <Icon icon="lucide:film" class="w-5 h-5" client:load />
          Semua Film
        </a>
        <a href="/anime" class="flex-shrink-0 px-6 py-3 bg-dark-300 text-secondary-300 rounded-full font-medium hover:bg-dark-200 hover:text-white transition-all duration-300 flex items-center gap-2">
          <Icon icon="mdi:anime" class="w-5 h-5" client:load />
          Anime
        </a>
        <a href="/series" class="flex-shrink-0 px-6 py-3 bg-dark-300 text-secondary-300 rounded-full font-medium hover:bg-dark-200 hover:text-white transition-all duration-300 flex items-center gap-2">
          <Icon icon="lucide:tv" class="w-5 h-5" client:load />
          Series
        </a>
        <a href="/bioskop" class="flex-shrink-0 px-6 py-3 bg-dark-300 text-secondary-300 rounded-full font-medium hover:bg-dark-200 hover:text-white transition-all duration-300 flex items-center gap-2">
          <Icon icon="lucide:clapperboard" class="w-5 h-5" client:load />
          Bioskop
        </a>
        <a href="/mendatang" class="flex-shrink-0 px-6 py-3 bg-dark-300 text-secondary-300 rounded-full font-medium hover:bg-dark-200 hover:text-white transition-all duration-300 flex items-center gap-2">
          <Icon icon="lucide:calendar" class="w-5 h-5" client:load />
          Akan Datang
        </a>
        <a href="/trending" class="flex-shrink-0 px-6 py-3 bg-dark-300 text-secondary-300 rounded-full font-medium hover:bg-dark-200 hover:text-white transition-all duration-300 flex items-center gap-2">
          <Icon icon="lucide:flame" class="w-5 h-5 text-orange-400" client:load />
          Trending
        </a>
        <a href="/top-rated" class="flex-shrink-0 px-6 py-3 bg-dark-300 text-secondary-300 rounded-full font-medium hover:bg-dark-200 hover:text-white transition-all duration-300 flex items-center gap-2">
          <Icon icon="lucide:star" class="w-5 h-5 text-yellow-400" client:load />
          Top Rated
        </a>
        <a href="/nonton-bareng" class="flex-shrink-0 px-6 py-3 bg-gradient-to-r from-violet-500 to-pink-500 text-white rounded-full font-medium hover:shadow-glow-violet transition-all duration-300 flex items-center gap-2">
          <Icon icon="mdi:account-star" class="w-5 h-5" client:load />
          VTuber Party
        </a>
      </div>
    </div>
  </section>

  <!-- Popular Movies -->
  <MovieSlider 
    title="Film Terpopuler"
    titleIcon="lucide:flame"
    subtitle="Film yang sedang banyak dibicarakan"
    movies={popularMovies}
    viewAllLink="/film/populer"
  />

  <!-- Now Playing -->
  <MovieSlider 
    title="Sedang Tayang di Bioskop"
    titleIcon="lucide:clapperboard"
    subtitle="Tonton sekarang di bioskop terdekat"
    movies={nowPlayingMovies}
    viewAllLink="/bioskop"
  />

  <!-- Anime Section -->
  <MovieSlider 
    title="Anime Populer"
    titleIcon="mdi:anime"
    subtitle="Film anime terbaik untuk ditonton"
    movies={animeMovies}
    viewAllLink="/anime"
  />

  <!-- VTuber Watch Party Banner -->
  <section class="py-12">
    <div class="container-custom">
      <div class="relative overflow-hidden bg-gradient-to-r from-violet-600/30 via-purple-600/30 to-pink-600/30 rounded-3xl p-8 md:p-12 border border-violet-500/30">
        <div class="absolute inset-0 bg-[url('/images/pattern-dots.svg')] opacity-10"></div>
        
        <!-- Floating elements -->
        <div class="absolute top-10 right-10 w-20 h-20 bg-violet-500/20 rounded-full blur-xl animate-float"></div>
        <div class="absolute bottom-10 left-10 w-32 h-32 bg-pink-500/20 rounded-full blur-xl animate-float" style="animation-delay: 1s;"></div>
        
        <div class="relative flex flex-col md:flex-row items-center justify-between gap-8">
          <div class="flex items-center gap-6">
            <div class="w-24 h-24 bg-gradient-to-br from-violet-500 to-pink-500 rounded-3xl flex items-center justify-center shadow-glow-violet">
              <Icon icon="mdi:account-star" class="w-12 h-12 text-white" client:load />
            </div>
            <div>
              <div class="flex items-center gap-2 mb-2">
                <span class="px-3 py-1 bg-red-500 text-white text-sm rounded-full flex items-center gap-1.5">
                  <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                  LIVE NOW
                </span>
                <span class="px-3 py-1 bg-violet-500/30 text-violet-300 text-sm rounded-full">
                  5 VTuber Online
                </span>
              </div>
              <h2 class="text-2xl md:text-3xl font-display font-bold text-white mb-2">
                VTuber Watch Party
              </h2>
              <p class="text-violet-200">Nonton film bareng VTuber favorit dengan fitur streaming sync!</p>
            </div>
          </div>
          <div class="flex flex-col sm:flex-row gap-3">
            <a href="/nonton-bareng" class="px-8 py-4 bg-gradient-to-r from-violet-500 to-pink-500 text-white rounded-xl font-bold hover:shadow-glow-violet transition-all flex items-center justify-center gap-2">
              <Icon icon="lucide:play" class="w-5 h-5" client:load />
              Tonton Sekarang
            </a>
            <a href="/vtuber" class="px-8 py-4 bg-white/10 backdrop-blur-sm border border-white/20 text-white rounded-xl font-medium hover:bg-white/20 transition-all flex items-center justify-center gap-2">
              <Icon icon="lucide:users" class="w-5 h-5" client:load />
              Lihat VTuber
            </a>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Editor's Pick / Featured -->
  <section class="section py-12">
    <div class="container-custom">
      <div class="flex items-end justify-between mb-8">
        <div>
          <h2 class="section-title flex items-center gap-2">
            <Icon icon="lucide:sparkles" class="w-6 h-6 text-yellow-400" client:load />
            Pilihan Editor
          </h2>
          <p class="section-subtitle">Rekomendasi terbaik dari tim ASTRO</p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Featured Movie -->
        <a href={`/film/${trendingMovies[0]?.id || 1}`} class="group relative aspect-video rounded-2xl overflow-hidden card-hover">
          <img 
            src={trendingMovies[0]?.backdropPath ? `https://image.tmdb.org/t/p/w1280${trendingMovies[0].backdropPath}` : '/images/placeholder-backdrop.jpg'}
            alt={trendingMovies[0]?.title || 'Featured Movie'}
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
          />
          <div class="absolute inset-0 bg-gradient-to-t from-dark-500 via-transparent to-transparent"></div>
          <div class="absolute bottom-0 left-0 right-0 p-6">
            <span class="badge-primary mb-3 flex items-center gap-1 w-fit">
              <Icon icon="lucide:award" class="w-3 h-3" client:load />
              Editor's Choice
            </span>
            <h3 class="text-2xl font-display font-bold text-white mb-2">{trendingMovies[0]?.title || 'Featured Movie'}</h3>
            <p class="text-secondary-300 line-clamp-2">
              {trendingMovies[0]?.overview || 'Deskripsi film akan ditampilkan di sini.'}
            </p>
            <div class="flex items-center gap-4 mt-4">
              <div class="flex items-center gap-1 text-yellow-400">
                <Icon icon="lucide:star" class="w-5 h-5 fill-current" client:load />
                <span class="font-bold">{trendingMovies[0]?.voteAverage?.toFixed(1) || '8.0'}</span>
              </div>
              <span class="text-secondary-400">{trendingMovies[0]?.releaseDate?.split('-')[0] || '2024'}</span>
            </div>
          </div>
        </a>

        <!-- Secondary Featured -->
        <div class="grid grid-cols-2 gap-4">
          {trendingMovies.slice(1, 3).map((movie) => (
            <a href={`/film/${movie.id}`} class="group relative aspect-[3/4] rounded-2xl overflow-hidden card-hover">
              <img 
                src={movie.posterPath ? `https://image.tmdb.org/t/p/w500${movie.posterPath}` : '/images/placeholder-poster.jpg'}
                alt={movie.title}
                class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-dark-500 via-transparent to-transparent"></div>
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <h3 class="text-lg font-bold text-white">{movie.title}</h3>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-yellow-400 text-sm font-bold flex items-center gap-1">
                    <Icon icon="lucide:star" class="w-3 h-3 fill-current" client:load />
                    {movie.voteAverage?.toFixed(1)}
                  </span>
                  <span class="text-secondary-400 text-sm">{movie.releaseDate?.split('-')[0]}</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Top Rated -->
  <MovieSlider 
    title="Top Rated Sepanjang Masa"
    titleIcon="lucide:star"
    subtitle="Film dengan rating tertinggi"
    movies={topRatedMovies}
    viewAllLink="/top-rated"
  />

  <!-- Upcoming Movies -->
  <MovieSlider 
    title="Akan Datang"
    titleIcon="lucide:calendar"
    subtitle="Film yang ditunggu-tunggu"
    movies={upcomingMovies}
    viewAllLink="/mendatang"
    showRating={false}
  />

  <!-- Newsletter / CTA Section -->
  <section class="section py-16 bg-gradient-to-b from-dark-500 to-dark-400">
    <div class="container-custom">
      <div class="card-glass p-8 md:p-12 text-center">
        <div class="max-w-2xl mx-auto space-y-6">
          <div class="w-16 h-16 mx-auto rounded-2xl bg-gradient-primary flex items-center justify-center shadow-glow">
            <Icon icon="lucide:bell" class="w-8 h-8 text-white" client:load />
          </div>
          <h2 class="text-2xl md:text-3xl font-display font-bold text-white">
            Jangan Lewatkan Update Film Terbaru!
          </h2>
          <p class="text-secondary-300">
            Dapatkan notifikasi film baru, rekomendasi personal, dan artikel menarik langsung di inbox kamu.
          </p>
          <form class="flex flex-col sm:flex-row gap-3 max-w-md mx-auto">
            <input 
              type="email" 
              placeholder="Masukkan email kamu"
              class="input flex-1"
            />
            <button type="submit" class="btn-primary px-8 flex items-center justify-center gap-2">
              <Icon icon="lucide:send" class="w-4 h-4" client:load />
              Berlangganan
            </button>
          </form>
          <p class="text-xs text-secondary-500">
            Dengan berlangganan, kamu setuju dengan kebijakan privasi kami. Bisa berhenti kapan saja.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats Section -->
  <section class="py-12 border-y border-dark-100">
    <div class="container-custom">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
        <div class="text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <Icon icon="lucide:film" class="w-8 h-8 text-primary-400" client:load />
          </div>
          <div class="text-3xl md:text-4xl font-display font-bold text-gradient mb-2">10,000+</div>
          <div class="text-secondary-400">Film & Series</div>
        </div>
        <div class="text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <Icon icon="lucide:message-square" class="w-8 h-8 text-violet-400" client:load />
          </div>
          <div class="text-3xl md:text-4xl font-display font-bold text-gradient-accent mb-2">50,000+</div>
          <div class="text-secondary-400">Review Pengguna</div>
        </div>
        <div class="text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <Icon icon="lucide:users" class="w-8 h-8 text-magenta-400" client:load />
          </div>
          <div class="text-3xl md:text-4xl font-display font-bold text-gradient mb-2">100,000+</div>
          <div class="text-secondary-400">Pengguna Aktif</div>
        </div>
        <div class="text-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <Icon icon="mdi:account-star" class="w-8 h-8 text-pink-400" client:load />
          </div>
          <div class="text-3xl md:text-4xl font-display font-bold text-gradient-accent mb-2">50+</div>
          <div class="text-secondary-400">VTuber Partner</div>
        </div>
      </div>
    </div>
  </section>
</MainLayout>

<style>
  @keyframes bounce-slow {
    0%, 100% {
      transform: translateY(0);
    }
    50% {
      transform: translateY(-10px);
    }
  }
  
  .animate-bounce-slow {
    animation: bounce-slow 2s ease-in-out infinite;
  }
  
  @keyframes float {
    0%, 100% {
      transform: translateY(0) scale(1);
    }
    50% {
      transform: translateY(-20px) scale(1.05);
    }
  }
  
  .animate-float {
    animation: float 6s ease-in-out infinite;
  }
</style>

<script>
  // Loading screen animation
  document.addEventListener('DOMContentLoaded', () => {
    const loadingScreen = document.getElementById('loading-screen');
    const progressBar = document.getElementById('loading-progress');
    
    if (loadingScreen && progressBar) {
      let progress = 0;
      const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;
        progressBar.style.width = `${progress}%`;
        
        if (progress >= 100) {
          clearInterval(interval);
          setTimeout(() => {
            loadingScreen.style.opacity = '0';
            loadingScreen.style.transform = 'scale(1.1)';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 500);
          }, 300);
        }
      }, 100);
    }
  });
</script>
